<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="manifest" href="/site.webmanifest" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1"
    />

    <title>SORACOM Harvest Data 用の SQLite 拡張を作りました &#x2F;&#x2F;&#x2F; ----- -..- -.... -...</title>

    <link rel="alternate"
    type="application/rss+xml" title="RSS" href="https://0x6b.github.io/rss.xml">

    <link
      href="https://fonts.googleapis.com/css?family=Noto+Sans+JP|Source+Code+Pro&display=swap"
      rel="stylesheet"
    />

    <link rel="stylesheet" href="https://0x6b.github.io/site.css">
  </head>

  <body>
    <div class="container">
      <div id="mobile-navbar" class="mobile-navbar">
        <div class="mobile-header-logo">
          <a href="/" class="logo">&#x2F;&#x2F;&#x2F; ----- -..- -.... -...</a>
        </div>
      </div>

      <header id="header">
        <div class="logo">
          <a href="https:&#x2F;&#x2F;0x6b.github.io">&#x2F;&#x2F;&#x2F; ----- -..- -.... -...</a>
        </div>
        <div class="menu">
          <ul>
            <li>
              <a href="https://github.com/0x6b">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path
                    d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"
                  ></path>
                </svg>
              </a>
            </li>
            <li>
              <a href="https://0x6b.github.io/rss.xml">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path d="M4 11a9 9 0 0 1 9 9"></path>
                  <path d="M4 4a16 16 0 0 1 16 16"></path>
                  <circle cx="5" cy="19" r="1"></circle>
                </svg>
              </a>
            </li>
          </ul>
        </div>
      </header>

      <main>
        <div class="content" id="mobile-panel">
          



<article class="post">
    
<header class="post-header">
  <h1 class="post-title">
    <a href="https:&#x2F;&#x2F;0x6b.github.io&#x2F;a-sqlite-extension-for-soracom-harvest-data&#x2F;">SORACOM Harvest Data 用の SQLite 拡張を作りました</a>
  </h1>
  <div class="post-meta">
    <svg
      xmlns="http://www.w3.org/2000/svg"
      width="12"
      height="12"
      viewBox="0 0 24 24"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
    >
      <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
      <line x1="16" y1="2" x2="16" y2="6"></line>
      <line x1="8" y1="2" x2="8" y2="6"></line>
      <line x1="3" y1="10" x2="21" y2="10"></line>
    </svg>
    <span class="post-time">2022-12-07</span>
  </div>
</header>

    <div class="post-content">
      <h2 id="hazimeni">はじめに</h2>
<p><a href="https://qiita.com/advent-calendar/2022/soracom">SORACOM Advent Calendar 2022</a> 7 日目の記事です。<a href="https://soracom.jp/services/harvest/">SORACOM Harvest</a> と <a href="https://www.sqlite.org/index.html">SQLite</a> のお話です。</p>
<h3 id="soracom-harvest-toha">SORACOM Harvest とは</h3>
<p><a href="https://users.soracom.io/ja-jp/docs/harvest/">SORACOM Harvest</a> はサーバーやストレージ、アプリケーションを構築することなく SORACOM Air を使っている IoT デバイスからのセンサー情報や位置情報など任意の情報を簡単に SORACOM プラットフォームに蓄積し可視化できるサービスです。IoT プロジェクト開始の早い段階で、まずはデバイスからどんなデータが送られているかを確認する際に簡単に利用できます。</p>
<p>以下の 2 つの機能を提供しています。今回はひとつめの <strong>SORACOM Harvest Data</strong> ネタです。</p>
<ul>
<li><strong>SORACOM Harvest Data</strong>: テキスト、JSON、バイナリなど<strong>データ</strong>を扱います。データのフォーマットに制限はありません。</li>
<li><strong>SORACOM Harvest Files</strong>: 画像やログなどの<strong>ファイル</strong>を扱います。</li>
</ul>
<h3 id="sqlite-toha">SQLite とは</h3>
<p>SQLite とは C で実装された組み込み型のデータベースエンジンです。簡潔な説明ですので <a href="https://www.sqlite.org/index.html">公式サイト</a> から引用します。</p>
<blockquote>
<p>SQLite is a C-language library that implements a <a href="https://www.sqlite.org/footprint.html">small</a>, <a href="https://www.sqlite.org/fasterthanfs.html">fast</a>, <a href="https://www.sqlite.org/selfcontained.html">self-contained</a>, <a href="https://www.sqlite.org/hirely.html">high-reliability</a>, <a href="https://www.sqlite.org/fullsql.html">full-featured</a>, SQL database engine. SQLite is the <a href="https://www.sqlite.org/mostdeployed.html">most used</a> database engine in the world. SQLite is built into all mobile phones and most computers and comes bundled inside countless other applications that people use every day. <a href="https://www.sqlite.org/about.html">More Information...</a></p>
</blockquote>
<p>ふだん意識する機会は少ないかもしれませんが、みなさんがお使いの Android や iPhone、そして主要ブラウザ (Firefox, Chrome, Safari) に搭載されており、世界でもっとも使用されているデータベースエンジンと言われています。</p>
<h2 id="soracom-harvest-data-to-sqlite">SORACOM Harvest Data と SQLite</h2>
<p>SQLite は実行時に機能を追加する <a href="https://www.sqlite.org/loadext.html">Run-Time Loadable Extensions</a> というメカニズムがあります。SQL 関数を追加したり、照合順序 (collating sequence) を定義したり、仮想テーブルを実装したりといろいろできます。公式サイトの <a href="https://www.sqlite.org/contrib">Contributed Files</a> セクションでは SQL に数学 (<code>acos</code>, <code>asin</code>, <code>atan</code> など) や文字列操作 (<code>replicate</code>, <code>charindex</code>, <code>lftstr</code> など) 関係の関数を追加する拡張 <a href="https://www.sqlite.org/contrib/download/extension-functions.c?get=25"><code>extension-functions.c</code></a> が紹介されています。</p>
<p>今回はこのメカニズムを利用して SORACOM Harvest Data に蓄積されているデータを SQLIte の <a href="https://www.sqlite.org/vtab.html">仮想テーブル</a> として取り扱える拡張を作ってみました。蓄積されたデータをクイックに手元で確認する際に便利に使えると思います。</p>
<p><a href="https://github.com/0x6b/libshsqlite">0x6b/libshsqlite: A SQLite extension which loads data from Soracom Harvest Data as a virtual table.</a></p>
<p>以下の環境で開発しました。プラットフォームに依存しないはずですが、他の OS ではうまく動かないかもしれません。</p>
<ul>
<li><a href="https://www.sqlite.org">SQLite</a> 3.40.0</li>
<li><a href="https://www.rust-lang.org">Rust</a> 1.65.0 (stable-aarch64-apple-darwin)</li>
<li>macOS 12.6 (Monterey) on Apple M1 MAX</li>
</ul>
<h2 id="shi-ifang">使い方</h2>
<h3 id="rust-woinsutorusuru">Rust をインストールする</h3>
<p>拡張本体 (<code>.so</code> や <code>.dll</code> ファイル) を GitHub から配布する準備がまにあわなかったため、お手元でビルドが必要です。そのため、だいぶ面倒ですが Rust のインストールから。<a href="https://www.rust-lang.org/ja/tools/install">Rust をインストール - Rust プログラミング言語</a> にしたがってください。</p>
<h3 id="sosukodoworu-shou-suru">ソースコードを入手する</h3>
<p>拡張のソースコードを GitHub リポジトリから入手します。</p>
<pre data-lang="shell" style="background-color:#0f1419;color:#bfbab0;" class="language-shell "><code class="language-shell" data-lang="shell"><span>$ git clone github.com/0x6b/libshsqlite
</span><span>$ cd libshsqlite
</span></code></pre>
<h3 id="soracom-to-soracom-harvest-data-woshi-ishi-meru">SORACOM と Soracom Harvest Data を使い始める</h3>
<p>SORACOM Air for セルラーの SIM あるいは <a href="https://soracom.jp/services/arc/">SORACOM Arc</a> によるバーチャル SIM/Subscriber を用意します。私は開発・テスト時に Arc を便利に使いました。</p>
<ol>
<li><a href="https://users.soracom.io/ja-jp/guides/getting-started/">SORACOM の利用を始める</a> にしたがって SIM カードをゲットし通信可能にします。バーチャル SIM も使用できます。SORACOM Arc の <a href="https://users.soracom.io/ja-jp/docs/arc/">公式ドキュメント</a> を参照しセットアップしてください。</li>
<li><a href="https://users.soracom.io/ja-jp/docs/harvest/enable-data/">SORACOM Harvest Data を有効化</a> します。</li>
<li>以下の権限を持つ <a href="https://users.soracom.io/ja-jp/docs/sam/create-sam-user/">SAM ユーザーを作成します</a>。セキュリティの観点から専用のユーザーを作成することをおすすめしますが、すでに SORACOM CLI などを利用中で、必要な権限を持っているユーザーを使っている場合はその認証情報を使っても OK です。SAM は、管理ユーザー毎にアクセス権限を設定できるアクセス管理機能で、不要なアクセスや操作ミスを未然に防げます。<pre data-lang="json" style="background-color:#0f1419;color:#bfbab0;" class="language-json "><code class="language-json" data-lang="json"><span>{
</span><span>  </span><span style="color:#c2d94c;">&quot;statements&quot;</span><span style="color:#bfbab0cc;">: </span><span>[
</span><span>    {
</span><span>      </span><span style="color:#c2d94c;">&quot;api&quot;</span><span style="color:#bfbab0cc;">: </span><span>[
</span><span>        </span><span style="color:#c2d94c;">&quot;Sim:getDataFromSim&quot;</span><span style="color:#bfbab0cc;">,
</span><span>        </span><span style="color:#c2d94c;">&quot;Subscriber:getDataFromSubscriber&quot;</span><span style="color:#bfbab0cc;">,
</span><span>        </span><span style="color:#c2d94c;">&quot;DataEntry:getDataEntries&quot;</span><span style="color:#bfbab0cc;">,
</span><span>        </span><span style="color:#c2d94c;">&quot;DataEntry:getDataEntry&quot;
</span><span>      ]</span><span style="color:#bfbab0cc;">,
</span><span>      </span><span style="color:#c2d94c;">&quot;effect&quot;</span><span style="color:#bfbab0cc;">: </span><span style="color:#c2d94c;">&quot;allow&quot;
</span><span>    }
</span><span>  ]
</span><span>}
</span></code></pre>
</li>
<li>作成した SAM ユーザーの認証キーを生成し <code>authKeyId</code> と <code>authKey</code> をメモっておきます。</li>
</ol>
<h3 id="soracom-puratutohuomuhedetawosong-xin-suru">SORACOM プラットフォームへデータを送信する</h3>
<p><a href="https://users.soracom.io/ja-jp/docs/harvest/send-data/">Harvest Data でデバイスのデータをクラウドで収集・取得・可視化する</a> を参考にしながら適当なデータを送信します。プロトコルは HTTP、TCP、UDP いずれでも構いません。</p>
<p>同じリポジトリに拡張のテストのために UDP と HTTP でデータを送信する <code>soracom_harvest_client</code> crate を作っており、簡易な CLI もありますのでそちらでも大丈夫です。</p>
<h4 id="udp-desong-xin-suru">UDP で送信する</h4>
<pre data-lang="shell" style="background-color:#0f1419;color:#bfbab0;" class="language-shell "><code class="language-shell" data-lang="shell"><span>$ cargo run -p soracom_harvest_client --quiet -- --udp hey
</span><span>2022-12-03T15:06:18.724035+09:00 hey
</span></code></pre>
<h4 id="http-desong-xin-suru">HTTP で送信する</h4>
<pre data-lang="shell" style="background-color:#0f1419;color:#bfbab0;" class="language-shell "><code class="language-shell" data-lang="shell"><span>$ cargo run -p soracom_harvest_client --quiet -- --http &#39;{&quot;temperature&quot;:20}&#39;
</span><span>2022-12-04T01:17:10.924355+09:00 {&quot;temperature&quot;:20}
</span></code></pre>
<h3 id="kuo-zhang-wobirudosuru">拡張をビルドする</h3>
<p><code>cargo</code> コマンドでビルドします。</p>
<pre data-lang="shell" style="background-color:#0f1419;color:#bfbab0;" class="language-shell "><code class="language-shell" data-lang="shell"><span>$ cargo build --release
</span><span>   Compiling autocfg v1.1.0
</span><span>   Compiling libc v0.2.137
</span><span>   Compiling cfg-if v1.0.0
</span><span>   ...
</span><span>   Compiling soracom_harvest_client v0.1.0 (/.../libshsqlite/soracom_harvest_client)
</span><span>   Compiling soracom_harvest_api_client v0.1.0 (/.../libshsqlite/soracom_harvest_api_client)
</span><span>   Compiling soracom_harvest_sqlite_extension v0.1.0 (/.../libshsqlite/soracom_harvest_sqlite_extension)
</span><span>    Finished release [optimized] target(s) in 22.68s
</span></code></pre>
<h3 id="kuo-zhang-wo-sqlite-nirodosuru">拡張を SQLite にロードする</h3>
<ol>
<li>SAM ユーザーの認証情報を環境変数としてエクスポートします。<pre data-lang="shell" style="background-color:#0f1419;color:#bfbab0;" class="language-shell "><code class="language-shell" data-lang="shell"><span>$ export LIBSHSQLITE_AUTH_KEY_ID=keyId-.. # authKeyId
</span><span>$ export LIBSHSQLITE_AUTH_KEY_SECRET=secret-... # authKey
</span></code></pre>
</li>
<li>SQLite を起動します。<pre data-lang="shell" style="background-color:#0f1419;color:#bfbab0;" class="language-shell "><code class="language-shell" data-lang="shell"><span>$ sqlite3
</span></code></pre>
</li>
<li>拡張をロードします。Windows の場合は <code>libshsqlite</code> ではなくおそらく <code>shsqlite</code> と指定します。<pre data-lang="shell" style="background-color:#0f1419;color:#bfbab0;" class="language-shell "><code class="language-shell" data-lang="shell"><span>sqlite&gt; .load target/release/libshsqlite
</span></code></pre>
<code>Error: unknown command or invalid arguments: &quot;load&quot;. Enter &quot;.help&quot; for help </code> というエラーが出てしまったら、お使いの SQLite が拡張のロードをサポートしていません。macOS の場合は <code>brew install sqlite3</code> などでよしなにインストールしてそちらを使用してください。</li>
</ol>
<h3 id="soracom-harvest-data-nodetawokarajia-xiang-teburuwozuo-cheng-suru">SORACOM Harvest Data のデータをから仮想テーブルを作成する</h3>
<p><code>CREATE VIRTUAL TABLE</code> 文を使って SORACOM Harvest Data のデータを元に仮想テーブルを作成します。データはこのタイミングでのみ取得しますので、仮想テーブル作成後に送信されたデータが必要な場合は作り直してください。仮想テーブルを <code>DROP</code> しても SORACOM Harvest Data に蓄積されているデータは削除されません。</p>
<pre data-lang="sql" style="background-color:#0f1419;color:#bfbab0;" class="language-sql "><code class="language-sql" data-lang="sql"><span>CREATE VIRTUAL TABLE harvest_data </span><span style="color:#ff7733;">USING</span><span> shsqlite(
</span><span>    IMSI     </span><span style="color:#c2d94c;">&#39;imsi-of-your-sim&#39;</span><span>,
</span><span>    COVERAGE </span><span style="color:#c2d94c;">&#39;japan&#39;
</span><span>);
</span></code></pre>
<p>以下のパラメータをモジュールの引数として指定できます。</p>
<table><thead><tr><th>引数</th><th>説明</th><th>デフォルト値</th><th style="text-align: center">必須</th></tr></thead><tbody>
<tr><td><code>IMSI</code></td><td>SIM カードの IMSI</td><td>なし</td><td style="text-align: center">x</td></tr>
<tr><td><code>FROM</code></td><td>取得するデータの開始時刻 (UNIX 時刻ミリ秒)</td><td>現在から 1 日前</td><td style="text-align: center"></td></tr>
<tr><td><code>TO</code></td><td>取得するデータの終了時刻 (UNIX 時刻ミリ秒)</td><td>現在時刻</td><td style="text-align: center"></td></tr>
<tr><td><code>COVERAGE</code></td><td>SIM のカバレッジ (<code>global</code> または <code>japan</code>)</td><td><code>global</code></td><td style="text-align: center"></td></tr>
<tr><td><code>LIMIT</code></td><td>取得するデータの数。1 から 1000 まで。</td><td>100</td><td style="text-align: center"></td></tr>
</tbody></table>
<pre data-lang="sql" style="background-color:#0f1419;color:#bfbab0;" class="language-sql "><code class="language-sql" data-lang="sql"><span>CREATE VIRTUAL TABLE harvest_data </span><span style="color:#ff7733;">USING</span><span> shsqlite(
</span><span>    IMSI </span><span style="color:#c2d94c;">&#39;...&#39;</span><span>,
</span><span>    </span><span style="color:#ff7733;">FROM </span><span style="color:#c2d94c;">&#39;...&#39;</span><span>,
</span><span>    TO </span><span style="color:#c2d94c;">&#39;...&#39;</span><span>,
</span><span>    COVERAGE </span><span style="color:#c2d94c;">&#39;japan|global&#39;</span><span>,
</span><span>    </span><span style="color:#ff7733;">LIMIT </span><span style="color:#c2d94c;">&#39;...&#39;
</span><span>);
</span></code></pre>
<h3 id="soracom-harvest-data-nixu-ji-sareteirudetawokuerisuru">SORACOM Harvest Data に蓄積されているデータをクエリする</h3>
<p>ここまでくるといつものように SQL が使用できます。ちなみに <code>INSERT</code> や <code>UPDATE</code> はできません。</p>
<pre data-lang="sql" style="background-color:#0f1419;color:#bfbab0;" class="language-sql "><code class="language-sql" data-lang="sql"><span style="color:#ff7733;">SELECT </span><span style="font-style:italic;color:#39bae6;">* </span><span style="color:#ff7733;">FROM</span><span> harvest_data;
</span><span style="font-style:italic;color:#5c6773;">-- time           content_type      value
</span><span style="font-style:italic;color:#5c6773;">-- -------------  ----------------  ------------------
</span><span style="font-style:italic;color:#5c6773;">-- 1670084230984  application/json  {&quot;temperature&quot;:20}
</span><span style="font-style:italic;color:#5c6773;">-- 1670083937548  application/json  {&quot;value&quot;:&quot;hey&quot;}
</span></code></pre>
<p>SORACOM Harvest Data のタイムスタンプは UNIX 時刻ミリ秒ですので <code>datetime</code> 関数で変換できます。</p>
<pre data-lang="sql" style="background-color:#0f1419;color:#bfbab0;" class="language-sql "><code class="language-sql" data-lang="sql"><span style="color:#ff7733;">SELECT datetime</span><span>(</span><span style="color:#ff7733;">time</span><span style="color:#f29668;">/</span><span style="color:#f29718;">1000</span><span>, </span><span style="color:#c2d94c;">&quot;unixepoch&quot;</span><span>) </span><span style="color:#f29668;">AS </span><span style="color:#ff7733;">datetime</span><span>, value </span><span style="color:#ff7733;">FROM</span><span> harvest_data;
</span><span style="font-style:italic;color:#5c6773;">-- datetime             value
</span><span style="font-style:italic;color:#5c6773;">-- -------------------  ------------------
</span><span style="font-style:italic;color:#5c6773;">-- 2022-12-03 16:17:10  {&quot;temperature&quot;:20}
</span><span style="font-style:italic;color:#5c6773;">-- 2022-12-03 16:12:17  {&quot;value&quot;:&quot;hey&quot;}
</span></code></pre>
<p>UDP で送信した文字列 <code>hey</code> が <code>{&quot;value&quot;:&quot;hey&quot;}</code> となっている部分はポイントです。<a href="https://users.soracom.io/ja-jp/docs/harvest/send-data/">公式ドキュメント</a> に記載のとおり、TCP または UDP で Harvest Data にデータを送信すると、データが Base64 形式でエンコードされた上で <code>payload</code> プロパティに設定された JSON 形式で蓄積されます。<code>hey</code> という文字列を UDP で送信すると、<a href="https://github.com/soracom/soracom-cli/">SORACOM CLI</a> や <a href="https://users.soracom.io/ja-jp/tools/api/reference/">SORACOM API</a> では以下のように取得できます。</p>
<pre data-lang="json" style="background-color:#0f1419;color:#bfbab0;" class="language-json "><code class="language-json" data-lang="json"><span>[
</span><span>  {
</span><span>    </span><span style="color:#c2d94c;">&quot;content&quot;</span><span style="color:#bfbab0cc;">: </span><span style="color:#c2d94c;">&quot;{</span><span style="color:#95e6cb;">\&quot;</span><span style="color:#c2d94c;">payload</span><span style="color:#95e6cb;">\&quot;</span><span style="color:#c2d94c;">:</span><span style="color:#95e6cb;">\&quot;</span><span style="color:#c2d94c;">aGV5</span><span style="color:#95e6cb;">\&quot;</span><span style="color:#c2d94c;">}&quot;</span><span style="color:#bfbab0cc;">,
</span><span>    </span><span style="color:#c2d94c;">&quot;contentType&quot;</span><span style="color:#bfbab0cc;">: </span><span style="color:#c2d94c;">&quot;application/json&quot;</span><span style="color:#bfbab0cc;">,
</span><span>    </span><span style="color:#c2d94c;">&quot;time&quot;</span><span style="color:#bfbab0cc;">: </span><span style="color:#f29718;">1670047578752
</span><span>  }
</span><span>]
</span></code></pre>
<p>SORACOM ユーザーコンソールには、上記のデータ(<code>content</code> 部分)を「一次処理済みデータ」として自動的にデコードして表示してくれる気の利いた機能があります。今回作った拡張も同様の変換を実装しました。</p>
<p>UDP でデータを送信すると、</p>
<pre data-lang="shell" style="background-color:#0f1419;color:#bfbab0;" class="language-shell "><code class="language-shell" data-lang="shell"><span>$ cargo run -p soracom_harvest_client --quiet -- --udp hey
</span><span>2022-12-03T15:11:15.373075+09:00 hey
</span></code></pre>
<p>SORACOM プラットフォームには以下のような形で蓄積され、</p>
<pre data-lang="json" style="background-color:#0f1419;color:#bfbab0;" class="language-json "><code class="language-json" data-lang="json"><span>{ </span><span style="color:#c2d94c;">&quot;payload&quot;</span><span style="color:#bfbab0cc;">: </span><span style="color:#c2d94c;">&quot;aGV5&quot; </span><span>}
</span></code></pre>
<p>SORACOM ユーザーコンソールでは <strong>一次処理済みデータ</strong> として以下のように表示されます。</p>
<pre data-lang="json" style="background-color:#0f1419;color:#bfbab0;" class="language-json "><code class="language-json" data-lang="json"><span>{ </span><span style="color:#c2d94c;">&quot;value&quot;</span><span style="color:#bfbab0cc;">: </span><span style="color:#c2d94c;">&quot;hey&quot; </span><span>}
</span></code></pre>
<p>同様に SQLite でも以下のように変換されて表示されます。</p>
<pre data-lang="sql" style="background-color:#0f1419;color:#bfbab0;" class="language-sql "><code class="language-sql" data-lang="sql"><span style="color:#ff7733;">SELECT </span><span style="font-style:italic;color:#39bae6;">* </span><span style="color:#ff7733;">FROM</span><span> harvest_data;
</span><span style="font-style:italic;color:#5c6773;">-- time           content_type      value
</span><span style="font-style:italic;color:#5c6773;">-- -------------  ----------------  ---------------
</span><span style="font-style:italic;color:#5c6773;">-- 1670083937548  application/json  {&quot;value&quot;:&quot;hey&quot;}
</span></code></pre>
<p><code>value</code> 列に <code>{&quot;value&quot;:&quot;...&quot;}</code> とあるのは冗長で少し気になりますが、整合性を考えてすべて JSON 形式にしました。SQLite は <a href="https://www.sqlite.org/json1.html">JSON 関数</a>がありますので、以下のように値だけ取り出せます。</p>
<pre data-lang="sql" style="background-color:#0f1419;color:#bfbab0;" class="language-sql "><code class="language-sql" data-lang="sql"><span style="color:#ff7733;">SELECT datetime</span><span>(</span><span style="color:#ff7733;">time</span><span style="color:#f29668;">/</span><span style="color:#f29718;">1000</span><span>, </span><span style="color:#c2d94c;">&#39;unixepoch&#39;</span><span>) </span><span style="color:#f29668;">as </span><span style="color:#ff7733;">datetime</span><span>,
</span><span>    value</span><span style="color:#f29668;">-&gt;&gt;</span><span style="color:#c2d94c;">&#39;$.value&#39; </span><span style="color:#f29668;">AS</span><span> value
</span><span>    </span><span style="color:#ff7733;">FROM</span><span> harvest_data;
</span><span style="font-style:italic;color:#5c6773;">-- datetime             value
</span><span style="font-style:italic;color:#5c6773;">-- -------------------  -----
</span><span style="font-style:italic;color:#5c6773;">-- 2022-12-03 16:12:17  hey
</span></code></pre>
<p>JSON 関数は <code>WHERE</code> 句にも使えて便利ですね。</p>
<pre data-lang="sql" style="background-color:#0f1419;color:#bfbab0;" class="language-sql "><code class="language-sql" data-lang="sql"><span style="color:#ff7733;">SELECT datetime</span><span>(</span><span style="color:#ff7733;">time</span><span style="color:#f29668;">/</span><span style="color:#f29718;">1000</span><span>, </span><span style="color:#c2d94c;">&quot;unixepoch&quot;</span><span>) </span><span style="color:#f29668;">AS </span><span style="color:#ff7733;">datetime</span><span>,
</span><span>    value</span><span style="color:#f29668;">-&gt;&gt;</span><span style="color:#c2d94c;">&#39;$.temperature&#39; </span><span style="color:#f29668;">AS</span><span> temperature
</span><span>    </span><span style="color:#ff7733;">FROM</span><span> harvest_data
</span><span>    </span><span style="color:#ff7733;">WHERE</span><span> value</span><span style="color:#f29668;">-&gt;&gt;</span><span style="color:#c2d94c;">&#39;$.temperature&#39; </span><span style="color:#f29668;">&gt; </span><span style="color:#f29718;">10</span><span>;
</span><span style="font-style:italic;color:#5c6773;">-- datetime             temperature
</span><span style="font-style:italic;color:#5c6773;">-- -------------------  -----------
</span><span style="font-style:italic;color:#5c6773;">-- 2022-12-03 16:17:10  20
</span></code></pre>
<p>SORACOM CLI と <a href="https://stedolan.github.io/jq/"><code>jq</code></a> コマンドを組み合わせ、base64 をデコードしつつ CSV に変換する場合は以下のような感じでしょうか。もう少しうまく書けそうですが jq 難しいです。</p>
<pre data-lang="shell" style="background-color:#0f1419;color:#bfbab0;" class="language-shell "><code class="language-shell" data-lang="shell"><span>$ soracom subscribers get-data --imsi xxxxxxxxxxxxxxx | jq -r &#39;.[]
</span><span>    | {
</span><span>        time: .time,
</span><span>        contentType: .contentType,
</span><span>        value: .content | fromjson | .payload | @base64d
</span><span>      }
</span><span>    | [.time, .contentType, .value]
</span><span>    | @csv&#39;
</span><span>1670048590499,&quot;application/json&quot;,&quot;hey&quot;
</span></code></pre>
<h2 id="shi-zhuang-nohua-woshao-si">実装の話を少し</h2>
<h3 id="sqlite-kuo-zhang-nozuo-rifang">SQLite 拡張の作り方</h3>
<p>Rust による SQLite 拡張の作り方は分かりやすい以下のブログ記事および関連する GitHub リポジトリ、そして公式ドキュメントを参照しました。</p>
<ul>
<li><a href="https://sergey.khabibullin.com/sqlite-extensions-in-rust/">Extending SQLite with Rust to support Excel files as virtual tables | Sergey Khabibullin - blog</a></li>
<li><a href="https://github.com/x2bool/xlite">x2bool/xlite: SQLite extension for querying Excel (.xlsx, .xls, .ods) files as virtual tables</a></li>
<li><a href="https://www.sqlite.org/loadext.html">Run-Time Loadable Extensions</a></li>
</ul>
<p>まずは手元の環境にあわせて <a href="https://github.com/rust-lang/rust-bindgen"><code>rust-bindgen</code></a> を使用して SQLite 拡張の FFI バインディングを生成しました。SQLite のバージョンに依存しない(後方互換性がある)はずですので上記リポジトリのバインディングをそのまま使用しても動くと思いましたが念のため。</p>
<pre data-lang="shell" style="background-color:#0f1419;color:#bfbab0;" class="language-shell "><code class="language-shell" data-lang="shell"><span>$ bindgen --default-macro-constant-type signed sqlite3ext.h -o sqlite3ext.rs
</span></code></pre>
<p>あとは既存の実装を参考に拡張の動作に必要な関数を実装していくだけです。ポイントは以下のとおりです。</p>
<ul>
<li><code>shsqlite_create</code>: 仮想テーブルを作成する際に呼ばれます。<code>CREATE VIRTUAL TABLE</code> 文に渡した IMSI やカバレッジなどの引数をパースし、SORACOM プラットフォームから Harvest Data に蓄積されたデータを取得し、仮想テーブルとして宣言します。データの取得は <code>soracom_harvest_api_client</code> crate として外出ししています。API 呼び出しの認証、データの取得、データの削除(テストに使用)のみを実装したシンプルな API クライアントです。</li>
<li><code>shsqlite_open</code>: 仮想カーソル(内部で保持しているデータにアクセスするカーソル)を初期化します。</li>
<li><code>shsqlite_next</code>: 仮想カーソルをひとつ進めます。</li>
<li><code>shsqlite_column</code>: 各列の値を返します。<a href="https://doc.rust-lang.org/std/vec/struct.Vec.html"><code>std::vec::Vec</code></a> に保存したデータを返しているだけです。</li>
<li><code>shsqlite_rowid</code>: 各列のインデックスを返します。</li>
</ul>
<h3 id="rust-noyokatutatokoro">Rust のよかったところ</h3>
<p>Option 型 (Rust における <a href="https://doc.rust-lang.org/std/option/enum.Option.html"><code>std::option::Option</code></a>) とパターンマッチをまともに使ったのは Rust が初めてだったのですが、エラーを含むすべてのパターンをコンパイラに矯正・強制されつつ自然な形でカバーできるので実装していて安心感がありました (これまでは JavaScript/TypeScript か Go が多かった)。TCP または UDP で送信されたデータをデコードする処理の実装のあたりです。</p>
<pre data-lang="rust" style="background-color:#0f1419;color:#bfbab0;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#ff7733;">fn </span><span style="color:#ffb454;">try_decode</span><span>(</span><span style="color:#f29718;">content</span><span style="color:#bfbab0cc;">:</span><span> String) </span><span style="color:#bfbab0cc;">-&gt;</span><span> String {
</span><span>    </span><span style="font-style:italic;color:#5c6773;">// API からゲットしたデータの content プロパティが {&quot;payload&quot;: &quot;value&quot;} の形になっている場合、
</span><span>    </span><span style="font-style:italic;color:#5c6773;">// それはきっと base64 でエンコードされたデータのはず
</span><span>    </span><span style="color:#ff7733;">if let </span><span style="font-style:italic;color:#39bae6;">Ok</span><span>(base64_encoded_payload) </span><span style="color:#f29668;">=
</span><span>        serde_json</span><span style="color:#f29668;">::</span><span>from_str</span><span style="color:#f29668;">::</span><span>&lt;Base64EncodedPayload&gt;(content</span><span style="color:#f29668;">.</span><span style="color:#f07178;">as_str</span><span>())
</span><span>    {
</span><span>        </span><span style="font-style:italic;color:#5c6773;">// payload プロパティの中身が base64 でデコードできて、
</span><span>        </span><span style="color:#ff7733;">if let </span><span style="font-style:italic;color:#39bae6;">Ok</span><span>(decoded) </span><span style="color:#f29668;">= </span><span>base64</span><span style="color:#f29668;">::</span><span>decode(base64_encoded_payload</span><span style="color:#f29668;">.</span><span>payload) {
</span><span>            </span><span style="font-style:italic;color:#5c6773;">// かつ、UTF-8 としてデコードできて、
</span><span>            </span><span style="color:#ff7733;">if let </span><span style="font-style:italic;color:#39bae6;">Ok</span><span>(</span><span style="color:#ff7733;">str</span><span>) </span><span style="color:#f29668;">= </span><span style="font-style:italic;color:#39bae6;">String</span><span style="color:#f29668;">::</span><span>from_utf8(decoded) {
</span><span>                </span><span style="font-style:italic;color:#5c6773;">// かつ、ASCII で表示可能な文字のみであった場合は、
</span><span>                </span><span style="color:#ff7733;">if str</span><span style="color:#f29668;">.</span><span style="color:#f07178;">chars</span><span>()</span><span style="color:#f29668;">.</span><span style="color:#f07178;">all</span><span>(|</span><span style="color:#f29718;">c</span><span>| </span><span style="color:#f07178;">matches!</span><span>(c </span><span style="color:#f29668;">as </span><span style="color:#ff7733;">u8</span><span style="color:#bfbab0cc;">, </span><span style="color:#f29718;">0x20</span><span style="color:#f29668;">..=</span><span style="color:#f29718;">0x7E</span><span>)) {
</span><span>                    </span><span style="font-style:italic;color:#5c6773;">// {&quot;value&quot;: &quot;デコードした文字列&quot;} という形で返却する
</span><span>                    </span><span style="color:#ff7733;">return </span><span style="color:#f07178;">format!</span><span>(</span><span style="color:#ff7733;">r</span><span style="color:#c2d94c;">#&quot;</span><span style="color:#95e6cb;">{{</span><span style="color:#c2d94c;">&quot;value&quot;:&quot;</span><span style="color:#f29718;">{str}</span><span style="color:#c2d94c;">&quot;</span><span style="color:#95e6cb;">}}</span><span style="color:#c2d94c;">&quot;#</span><span>)</span><span style="color:#bfbab0cc;">;
</span><span>                }
</span><span>            }
</span><span>        }
</span><span>    }
</span><span>    </span><span style="font-style:italic;color:#5c6773;">// 上記の条件のどれにも引っかからなかった場合は、元の content をそのまま返す
</span><span>    content
</span><span>}
</span></code></pre>
<p>また、<code>Arc&lt;Mutex&lt;...&gt;&gt;</code> によって参照を共有しつつ値を変更するというパターンも、シグネチャは見づらいものの慣れてくると快適でした。</p>
<p><a href="https://crates.io/">crates.io</a> を使えること、<a href="https://github.com/rust-lang/cargo/">cargo</a>、<a href="https://github.com/rust-lang/rust-clippy">clippy</a> といったツールチェインを使えること、monorepo (<a href="https://doc.rust-lang.org/book/ch14-03-cargo-workspaces.html">ワークスペース</a>) が標準でサポートされていること、テストの仕組みも用意されていることなど、全体を通してよい開発体験でした。</p>
<h2 id="matome">まとめ</h2>
<p>SORACOM Harvest Data に蓄積されたデータを SQLite で取り扱える拡張を、最近(というかずっと)勉強中の Rust を使って開発しました。最近コードを書く機会がめっきり減っているのでとても楽しめました。<a href="https://qiita.com/advent-calendar/2022/soracom">SORACOM Advent Calendar 2022</a> をセットアップしてくださった <a href="https://soracom-ug.jp/">SORACOM ユーザーグループ</a> (SORACOM UG) のみなさまに感謝します。</p>
<p>2022 年 12 月現在、SORACOM Harvest Data は 1 アカウントあたり毎月 31 日分(1 日 2,000 書き込みリクエストまで)の無料利用枠があります。ぜひご活用ください。</p>

    </div>

    
    

    <div class="post-footer">
        
            
                <div class="post-tags">
                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line></svg>
                    
                        <a href="https://0x6b.github.io/tags/soracom/">#soracom</a>
                    
                        <a href="https://0x6b.github.io/tags/harvest/">#harvest</a>
                    
                        <a href="https://0x6b.github.io/tags/sqlite/">#sqlite</a>
                    
                        <a href="https://0x6b.github.io/tags/extension/">#extension</a>
                    
                </div>
            
            
        

    </div>

    
    
</article>


        </div>
      </main>

      <footer id="footer">
        <p><a href="https://github.com/0x6b">0x6b</a> / Opinion here is mine, not employer's / <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a></p>
      </footer>
    </div>
  </body>
</html>
