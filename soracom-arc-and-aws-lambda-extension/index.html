<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="manifest" href="/site.webmanifest" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1"
    />

    <title>soratun を改造して AWS Lambda から簡単に SORACOM Arc を使ってみました &#x2F;&#x2F;&#x2F; ----- -..- -.... -...</title>

    <link rel="alternate"
    type="application/rss+xml" title="RSS" href="https://0x6b.github.io/rss.xml">

    <link
      href="https://fonts.googleapis.com/css?family=Noto+Sans+JP|Source+Code+Pro&display=swap"
      rel="stylesheet"
    />

    <link rel="stylesheet" href="https://0x6b.github.io/site.css">

    
<!-- facebook open graph tags -->
<meta property="og:type" content="website" />
<meta property="og:url" content="https:&#x2F;&#x2F;0x6b.github.io&#x2F;soracom-arc-and-aws-lambda-extension&#x2F;" />
<meta property="og:title" content="soratun を改造して AWS Lambda から簡単に SORACOM Arc を使ってみました &#x2F;&#x2F;&#x2F; ----- -..- -.... -..." />
<meta property="og:image" content="https:&#x2F;&#x2F;0x6b.github.io&#x2F;soracom-arc-and-aws-lambda-extension&#x2F;ogimage.png" />

<!-- twitter card tags additive with the og: tags -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:domain" value="0x6b.github.io" />
<meta name="twitter:title" value="soratun を改造して AWS Lambda から簡単に SORACOM Arc を使ってみました &#x2F;&#x2F;&#x2F; ----- -..- -.... -..." />
<meta name="twitter:image" content="https:&#x2F;&#x2F;0x6b.github.io&#x2F;soracom-arc-and-aws-lambda-extension&#x2F;ogimage.png" />
<meta name="twitter:url" value="https:&#x2F;&#x2F;0x6b.github.io&#x2F;soracom-arc-and-aws-lambda-extension&#x2F;" />

  </head>

  <body>
    <div class="container">
      <div id="mobile-navbar" class="mobile-navbar">
        <div class="mobile-header-logo">
          <a href="/" class="logo">&#x2F;&#x2F;&#x2F; ----- -..- -.... -...</a>
        </div>
      </div>

      <header id="header">
        <div class="logo">
          <a href="https:&#x2F;&#x2F;0x6b.github.io">&#x2F;&#x2F;&#x2F; ----- -..- -.... -...</a>
        </div>
        <div class="menu">
          <ul>
            <li>
              <a href="https://github.com/0x6b">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path
                    d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"
                  ></path>
                </svg>
              </a>
            </li>
            <li>
              <a href="https://0x6b.github.io/rss.xml">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path d="M4 11a9 9 0 0 1 9 9"></path>
                  <path d="M4 4a16 16 0 0 1 16 16"></path>
                  <circle cx="5" cy="19" r="1"></circle>
                </svg>
              </a>
            </li>
          </ul>
        </div>
      </header>

      <main>
        <div class="content" id="mobile-panel">
          



<article class="post">
    
<header class="post-header">
  <h1 class="post-title">
    <a href="https:&#x2F;&#x2F;0x6b.github.io&#x2F;soracom-arc-and-aws-lambda-extension&#x2F;">soratun を改造して AWS Lambda から簡単に SORACOM Arc を使ってみました</a>
  </h1>
  <div class="post-meta">
    <svg
      xmlns="http://www.w3.org/2000/svg"
      width="12"
      height="12"
      viewBox="0 0 24 24"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
    >
      <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
      <line x1="16" y1="2" x2="16" y2="6"></line>
      <line x1="8" y1="2" x2="8" y2="6"></line>
      <line x1="3" y1="10" x2="21" y2="10"></line>
    </svg>
    <span class="post-time">2021-12-16</span>
  </div>
</header>

    <div class="post-content">
      <blockquote class="disclosure">
<p><a href="https://www.caa.go.jp/policies/policy/representation/fair_labeling/guideline/assets/representation_cms216_230328_03.pdf">「一般消費者が事業者の表示であることを判別することが困難である表示」の運用基準</a>に基づく開示: この記事は記載の日付時点で<a href="https://soracom.jp">株式会社ソラコム</a>のエンジニアリングチームに所属する社員が執筆しました。ただし、個人としての投稿であり、株式会社ソラコムとしての正式な発言や見解ではありません。</p>
</blockquote>
<h2 id="hazimeni">はじめに</h2>
<p><a href="https://qiita.com/advent-calendar/2021/soracominc">株式会社ソラコム Advent Calendar 2021</a> 16 日目の記事です。今日は 2021 年 6 月に発表された <a href="https://soracom.jp/services/arc/">SORACOM Arc</a> (以下 Arc) とそのクライアントエージェント <a href="https://github.com/soracom/soratun/">soratun</a>、そして AWS Lambda extension のお話です。</p>
<h3 id="soracom-arc-toha">SORACOM Arc とは</h3>
<p><a href="https://users.soracom.io/ja-jp/docs/arc/">SORACOM Arc</a> はソラコムが 2021 年 6 月にリリースした、SIM カードがなくてもソラコムのプラットフォームサービスをセキュアに利用できるサービスです。伝送路の安全性を <a href="https://www.wireguard.com/">WireGuard</a> を使って確保しており、WireGuard を使える機器であれば iPhone や Android のようなスマートフォンから、Raspberry Pi を含む Linux、そして M5Stack で利用されている ESP32 でも動作します(参照: <a href="https://zenn.dev/ciniml/articles/wireguard-esp32">WireGuard for ESP32 の実装的なところ</a>—ciniml さんによる <a href="https://qiita.com/advent-calendar/2021/soracom">SORACOM Advent Calendar 2021</a> 7 日目の記事)。</p>
<p>物理的な SIM カードに代わってバーチャル SIM を発行し、バーチャル SIM に紐付いた WireGuard 認証情報を使って SORACOM プラットフォームと接続します。</p>
<h3 id="soratun-toha">soratun とは</h3>
<p>soratun (<em><strong>sora</strong></em>-com <em><strong>tun</strong></em>-nel, ソラタン) とは SORACOM Arc を簡単・安全に使っていただくために開発した WireGuard クライアントで、MIT ライセンスで公開しています。</p>
<p>バーチャル SIM は <a href="https://console.soracom.io">SORACOM ユーザーコンソール</a> や <a href="https://users.soracom.io/ja-jp/tools/cli/">SORACOM CLI</a> から作成できますが、soratun は作成から仮想ネットワークデバイス(tun)を使った WireGuard 接続までを一つのコンパクトなバイナリファイルでまとめていい感じにやってくれます。詳細は <a href="https://users.soracom.io/ja-jp/docs/arc/soratun-overview/">公式ドキュメント</a> や <a href="https://soracom.connpass.com/event/218134/">SORACOM Meetup〜Wi-Fi からもソラコムを！はじめよう新サービス SORACOM Arc</a> で発表した資料 <a href="https://speakerdeck.com/soracom/soracom-meetup-arc-soratun-overview">クライアントエージェント soratun とは / SORACOM Meetup Arc soratun overview - Speaker Deck</a> をご覧ください。</p>
<h3 id="aws-lambda-extension-toha">AWS Lambda Extension とは</h3>
<p>AWS Lambda extension は 2021 年 5 月に GA となった比較的新しい機能で、AWS Lambda (以下 Lambda) 関数の実行環境を独自に拡張できます。こちらも詳細は <a href="https://docs.aws.amazon.com/lambda/latest/dg/using-extensions.html">公式ドキュメント</a> をご覧いただきたいところですが、誤解を恐れずに今回のユースケースに絞って簡単に説明すると、Lambda の実行環境に Lambda 関数とネットワーク経由でコミュニケーションできる独自のプロセスを立てられる機能です。</p>
<p>GA が発表された <a href="https://aws.amazon.com/jp/blogs/aws/getting-started-with-using-your-favorite-operational-tools-on-aws-lambda-extensions-are-now-generally-available/">記事</a> ではトレーシング、ロギング、モニタリング、プロファイリングなどの extension が紹介されています。</p>
<h2 id="aws-lambda-extension-to-soracom-arc">AWS Lambda Extension と SORACOM Arc</h2>
<p>ようやく本題です。Lambda extension と改造版 soratun を組み合わせて以下のようなことをやりました。</p>
<ol>
<li><code>soratun</code> を SORACOM プラットフォームへのプロキシサーバーとして動作するよう改造しました (雑に <code>soraproxy</code> と命名)。</li>
<li><code>soraproxy</code> を Lambda extension として動作するよう AWS のサンプルを元にラッパースクリプトを作りました。</li>
<li>Lambda extension を経由して Lambda 関数からプログラミング言語を問わず簡単に SORACOM プラットフォームへデータを送信できるようになりました。</li>
</ol>
<p>アウトプットの質と量で尊敬する 1stship さんによる <a href="https://qiita.com/advent-calendar/2021/soracom">SORACOM Advent Calendar 2021</a> 13 日目の記事 <a href="https://qiita.com/1stship/items/6885e6d1dd42defbb448">SORACOM Arc を特権なしで使えるツールを開発してみた</a> を直前に拝見してネタが重複してしまったかと焦りましたが、アプローチが異なっていたのでよかったです。そして 1stship さんの記事は AWS やソラコムのスクリーンショット満載で大変親切であります。</p>
<p>以下にそれぞれのステップを説明します。</p>
<h3 id="soratun-nogai-zao"><code>soratun</code> の改造</h3>
<p><code>soratun</code> を SORACOM プラットフォームへのプロキシサーバーとして動作するよう改造します。既存の <code>soratun</code> コマンドとは別に <code>soraproxy</code> というコマンドを作っています。</p>
<p><code>soratun</code> の WireGuard 実装そのものはユーザー空間で動くとはいえ、稼動には tun デバイスの作成が必須です。実際に試していないのですが、Lambda extension では root 権限(正確には <code>NET_ADMIN</code> capability)が必要になるネットワークインターフェースの作成ができないような気がしました。</p>
<p>そこで、<code>soratun</code> が使用している <a href="https://git.zx2c4.com/wireguard-go">wireguard-go</a> に含まれる <a href="https://git.zx2c4.com/wireguard-go/tree/tun/netstack"><code>tun/netstack</code></a> パッケージを利用します。このパッケージはドキュメントがほとんど無いのですが、<a href="https://gvisor.dev/">gVisor</a> の TCP/IP スタックを使った WireGuard トンネルを提供します。すなわちネットワークインターフェースを含め WireGuard 接続を全部ユーザー空間で実装できる(= 特別な権限が不要)ことになります。</p>
<table><thead><tr><th></th><th>soratun</th><th>soraproxy</th></tr></thead><tbody>
<tr><td>WireGuard</td><td>ユーザー空間 (wireguard-go)</td><td>ユーザー空間 (wireguard-go)</td></tr>
<tr><td>ネットワーク</td><td>カーネル (tun)</td><td>ユーザー空間 (gVisor)</td></tr>
</tbody></table>
<p>プロキシサーバーとしての実装はだいぶ適当で、SORACOM プラットフォームの <a href="https://users.soracom.io/ja-jp/docs/unified-endpoint/">Unified Endpoint</a> に対する HTTP クライアントを作成し、受け取った POST リクエストを転送します。</p>
<ul>
<li><a href="https://github.com/0x6b/soratun/blob/8735ab99fe3ea2fd2f76bbc7ca56710431b1a5ed/cmd/soraproxy_up.go"><code>cmd/soraproxy_up.go</code></a></li>
</ul>
<p>今回のポイントである <code>tun/netstack</code> パッケージを使用しているのはこのあたりです。gVisor を使ったトンネルを作成し Go の <a href="https://pkg.go.dev/net/http#Client">net/http.Client</a> の <code>Transport</code> として渡しています。簡単ですね。</p>
<ul>
<li><a href="https://github.com/0x6b/soratun/blob/8735ab99fe3ea2fd2f76bbc7ca56710431b1a5ed/unified_endpoint_http_client.go#L47"><code>unified_endpoint_http_client.go#47</code></a></li>
</ul>
<h3 id="aws-lambda-extension-tositepatukezi">AWS Lambda Extension としてパッケージ</h3>
<p>AWS の公式サンプル <a href="https://github.com/aws-samples/aws-lambda-extensions/blob/d240b9d9658b2f5fec7ca96fbb2bb773f0221c9e/custom-runtime-extension-demo/extensionssrc/extensions/extension1.sh"><code>aws-lambda-extensions/extension1.sh</code></a> を参考に <code>soraproxy</code> が Lambda extension として動作するようラッパースクリプトを作成します。</p>
<ul>
<li><a href="https://github.com/0x6b/soratun/blob/8735ab99fe3ea2fd2f76bbc7ca56710431b1a5ed/aws-lambda-extension/extensions/extension.sh#L43"><code>aws-lambda-extension/extensions/extension.sh#43</code></a></li>
</ul>
<p><code>LAMBDA_TASK_ROOT</code> 環境変数を使用し、SORACOM Arc の認証情報 (<code>arc.json</code>) は Lambda 関数にパッケージされたファイルを参照しています。Lambda 関数単位でバーチャル SIM を切り替えるのも簡単ですね。最後に <code>&amp;</code> を付けずにブロックしてしまってはまりましたが、厳密には <code>soraproxy</code> の起動まで待つようにしないと問題が起きそうな概念検証感あふれる実装であります。</p>
<pre data-lang="bash" style="background-color:#0f1419;color:#bfbab0;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#ffb454;">/opt/bin/soraproxy</span><span> up</span><span style="color:#f29718;"> --config </span><span>${LAMBDA_TASK_ROOT}/arc.json</span><span style="color:#f29718;"> --address </span><span>${SORAPROXY_ADDRESS}</span><span style="color:#f29718;"> --port </span><span>${SORAPROXY_PORT} </span><span style="color:#f29668;">&amp;
</span></code></pre>
<p><code>soraproxy</code> のバイナリと上記のスクリプトを <a href="https://github.com/0x6b/soratun/blob/8735ab99fe3ea2fd2f76bbc7ca56710431b1a5ed/aws-lambda-extension/scripts/build.sh"><code>aws-lambda-extension/scripts/build.sh</code></a> を使って Zip ファイルにまとめ、Lambda レイヤーとして登録します(参考: <a href="https://docs.aws.amazon.com/ja_jp/lambda/latest/dg/configuration-layers.html">Lambda レイヤーの作成と共有 - AWS Lambda</a>)。</p>
<h3 id="soraproxy-woshi-yong-suru-aws-lambda-guan-shu-noshi-zhuang"><code>soraproxy</code> を使用する AWS Lambda 関数の実装</h3>
<p>新しい Lambda 関数を作って上記の Lambda extension をレイヤーとして指定します(Lambda 関数の言語は何でも使えますが、レイヤーは ARN で指定する必要がありました)。</p>
<p>今回は JavaScript でテストしました。関数(<a href="https://github.com/0x6b/soratun/blob/8735ab99fe3ea2fd2f76bbc7ca56710431b1a5ed/aws-lambda-extension/example/index.js"><code>index.js</code></a>)と SORACOM Arc の認証情報を保存した <code>arc.json</code> (<code>soratun</code> で使っているものそのまま)の 2 つのみです。Lambda 関数としてはシンプルで、<code>soraproxy</code> が待ち受けている <code>localhost:8080</code> へ <code>POST</code> しています。これだけで Unified Endpoint へデータが送信できます。</p>
<pre data-lang="js" style="background-color:#0f1419;color:#bfbab0;" class="language-js "><code class="language-js" data-lang="js"><span style="color:#ff7733;">const </span><span>http </span><span style="color:#f29668;">= </span><span style="color:#f07178;">require</span><span>(</span><span style="color:#c2d94c;">&quot;http&quot;</span><span>)</span><span style="color:#bfbab0cc;">;
</span><span>
</span><span style="font-style:italic;color:#39bae6;">exports</span><span style="color:#f29668;">.</span><span style="color:#ffb454;">handler </span><span style="color:#f29668;">= </span><span style="color:#ff7733;">async </span><span>(</span><span style="color:#f29718;">event</span><span>) </span><span style="color:#ff7733;">=&gt;
</span><span>  </span><span style="color:#f29668;">new </span><span style="color:#59c2ff;">Promise</span><span>(</span><span style="color:#ff7733;">async </span><span>(</span><span style="color:#f29718;">resolve</span><span style="color:#bfbab0cc;">, </span><span style="color:#f29718;">reject</span><span>) </span><span style="color:#ff7733;">=&gt; </span><span>{
</span><span>    </span><span style="color:#ff7733;">const </span><span>req </span><span style="color:#f29668;">= </span><span>http</span><span style="color:#f29668;">.</span><span style="color:#ffb454;">request</span><span>(
</span><span>      { host</span><span style="color:#bfbab0cc;">: </span><span style="color:#c2d94c;">&quot;localhost&quot;</span><span style="color:#bfbab0cc;">, </span><span>port</span><span style="color:#bfbab0cc;">: </span><span style="color:#f29718;">8080</span><span style="color:#bfbab0cc;">, </span><span>path</span><span style="color:#bfbab0cc;">: </span><span style="color:#c2d94c;">&quot;/&quot;</span><span style="color:#bfbab0cc;">, </span><span>method</span><span style="color:#bfbab0cc;">: </span><span style="color:#c2d94c;">&quot;POST&quot; </span><span>}</span><span style="color:#bfbab0cc;">,
</span><span>      (</span><span style="color:#f29718;">res</span><span>) </span><span style="color:#ff7733;">=&gt; </span><span>{
</span><span>        </span><span style="color:#ff7733;">let </span><span>buffer </span><span style="color:#f29668;">= </span><span style="color:#c2d94c;">&quot;&quot;</span><span style="color:#bfbab0cc;">;
</span><span>        res</span><span style="color:#f29668;">.</span><span style="color:#ffb454;">on</span><span>(</span><span style="color:#c2d94c;">&quot;data&quot;</span><span style="color:#bfbab0cc;">, </span><span>(</span><span style="color:#f29718;">chunk</span><span>) </span><span style="color:#ff7733;">=&gt; </span><span>(buffer </span><span style="color:#f29668;">+= </span><span>chunk))</span><span style="color:#bfbab0cc;">;
</span><span>        res</span><span style="color:#f29668;">.</span><span style="color:#ffb454;">on</span><span>(</span><span style="color:#c2d94c;">&quot;end&quot;</span><span style="color:#bfbab0cc;">, </span><span>() </span><span style="color:#ff7733;">=&gt; </span><span style="color:#ffb454;">resolve</span><span>({ statusCode</span><span style="color:#bfbab0cc;">: </span><span style="color:#f29718;">200</span><span style="color:#bfbab0cc;">, </span><span>body</span><span style="color:#bfbab0cc;">: </span><span>buffer }))</span><span style="color:#bfbab0cc;">;
</span><span>      }
</span><span>    )</span><span style="color:#bfbab0cc;">;
</span><span>    req</span><span style="color:#f29668;">.</span><span style="color:#ffb454;">on</span><span>(</span><span style="color:#c2d94c;">&quot;error&quot;</span><span style="color:#bfbab0cc;">, </span><span>(</span><span style="color:#f29718;">e</span><span>) </span><span style="color:#ff7733;">=&gt;
</span><span>      </span><span style="color:#ffb454;">reject</span><span>({ statusCode</span><span style="color:#bfbab0cc;">: </span><span style="color:#f29718;">500</span><span style="color:#bfbab0cc;">, </span><span>body</span><span style="color:#bfbab0cc;">: </span><span style="font-style:italic;color:#f29668;">JSON</span><span style="color:#f29668;">.</span><span style="color:#f07178;">stringify</span><span>(e</span><span style="color:#f29668;">.</span><span>message</span><span style="color:#bfbab0cc;">, </span><span style="color:#f29718;">null</span><span style="color:#bfbab0cc;">, </span><span style="color:#f29718;">2</span><span>) })
</span><span>    )</span><span style="color:#bfbab0cc;">;
</span><span>    req</span><span style="color:#f29668;">.</span><span style="color:#f07178;">write</span><span>(</span><span style="font-style:italic;color:#f29668;">JSON</span><span style="color:#f29668;">.</span><span style="color:#f07178;">stringify</span><span>(event))</span><span style="color:#bfbab0cc;">;
</span><span>    req</span><span style="color:#f29668;">.</span><span style="color:#ffb454;">end</span><span>()</span><span style="color:#bfbab0cc;">;
</span><span>  })</span><span style="color:#bfbab0cc;">;
</span></code></pre>
<p><img src="https://0x6b.github.io/soracom-arc-and-aws-lambda-extension/lambda-management-console.png" alt="AWS Lambda Management Console" /></p>
<p>テスト実行すると、以下のように Lambda extension (<code>soraproxy</code>) が WireGuard 接続を初期化し、Unified Endpoint へ <code>POST</code> している様子が見えます。</p>
<pre style="background-color:#0f1419;color:#bfbab0;"><code><span>Function Logs
</span><span>15:23:32 setup proxy server for Unified Endpoint
</span><span>DEBUG: (soraproxy/proxy) 2021/12/12 15:23:32 proxy server for Unified Endpoint started at 0.0.0.0:8080
</span><span>DEBUG: (soraproxy/proxy/tunnel) 2021/12/12 15:23:32 Routine: handshake worker 1 - started
</span><span>DEBUG: (soraproxy/proxy/tunnel) 2021/12/12 15:23:32 Routine: encryption worker 1 - started
</span><span>DEBUG: (soraproxy/proxy/tunnel) 2021/12/12 15:23:32 Routine: decryption worker 1 - started
</span><span>DEBUG: (soraproxy/proxy/tunnel) 2021/12/12 15:23:32 Routine: encryption worker 2 - started
</span><span>DEBUG: (soraproxy/proxy/tunnel) 2021/12/12 15:23:32 Routine: receive incoming v4 - started
</span><span>DEBUG: (soraproxy/proxy/tunnel) 2021/12/12 15:23:32 peer(cx/Q…7vVA) - Routine: sequential sender - started
</span><span>DEBUG: (soraproxy/proxy/tunnel) 2021/12/12 15:23:32 peer(cx/Q…7vVA) - Routine: sequential receiver - started
</span><span>DEBUG: (soraproxy/proxy/tunnel) 2021/12/12 15:23:32 Routine: decryption worker 2 - started
</span><span>DEBUG: (soraproxy/proxy/tunnel) 2021/12/12 15:23:32 Routine: handshake worker 2 - started
</span><span>DEBUG: (soraproxy/proxy/tunnel) 2021/12/12 15:23:32 Routine: TUN reader - started
</span><span>DEBUG: (soraproxy/proxy/tunnel) 2021/12/12 15:23:32 Routine: event worker - started
</span><span>DEBUG: (soraproxy/proxy/tunnel) 2021/12/12 15:23:32 Interface up requested
</span><span>EXTENSION	Name: extension.sh	State: Ready	Events: [SHUTDOWN,INVOKE]
</span><span>+ trap - SIGTERM
</span><span>+ EVENT_DATA=&#39;{&quot;eventType&quot;:&quot;INVOKE&quot;,&quot;deadlineMs&quot;:1639322915570,&quot;requestId&quot;:&quot;xxxxxxxx-68e3-4be4-a682-e362c35837ff&quot;,&quot;invokedFunctionArn&quot;:&quot;arn:aws:lambda:ap-northeast-1:xxxxxxxxxxxx:function:soraproxy&quot;,&quot;tracing&quot;:{&quot;type&quot;:&quot;X-Amzn-Trace-Id&quot;,&quot;value&quot;:&quot;Root=1-61b613f3-37678b955845097c7d499e07;Parent=033592cd59b3e60b;Sampled=0&quot;}}&#39;
</span><span>+ [[ {&quot;eventType&quot;:&quot;INVOKE&quot;,&quot;deadlineMs&quot;:1639322915570,&quot;requestId&quot;:&quot;xxxxxxxx-68e3-4be4-a682-e362c35837ff&quot;,&quot;invokedFunctionArn&quot;:&quot;arn:aws:lambda:ap-northeast-1:xxxxxxxxxxxx:function:soraproxy&quot;,&quot;tracing&quot;:{&quot;type&quot;:&quot;X-Amzn-Trace-Id&quot;,&quot;value&quot;:&quot;Root=1-61b613f3-37678b955845097c7d499e07;Parent=033592cd59b3e60b;Sampled=0&quot;}} == *\S\H\U\T\D\O\W\N* ]]
</span><span>+ echo &#39;[extension.sh] Received event: {&quot;eventType&quot;:&quot;INVOKE&quot;,&quot;deadlineMs&quot;:1639322915570,&quot;requestId&quot;:&quot;xxxxxxxx-68e3-4be4-a682-e362c35837ff&quot;,&quot;invokedFunctionArn&quot;:&quot;arn:aws:lambda:ap-northeast-1:xxxxxxxxxxxx:function:soraproxy&quot;,&quot;tracing&quot;:{&quot;type&quot;:&quot;X-Amzn-Trace-Id&quot;,&quot;value&quot;:&quot;Root=1-61b613f3-37678b955845097c7d499e07;Parent=033592cd59b3e60b;Sampled=0&quot;}}&#39;
</span><span>[extension.sh] Received event: {&quot;eventType&quot;:&quot;INVOKE&quot;,&quot;deadlineMs&quot;:1639322915570,&quot;requestId&quot;:&quot;xxxxxxxx-68e3-4be4-a682-e362c35837ff&quot;,&quot;invokedFunctionArn&quot;:&quot;arn:aws:lambda:ap-northeast-1:xxxxxxxxxxxx:function:soraproxy&quot;,&quot;tracing&quot;:{&quot;type&quot;:&quot;X-Amzn-Trace-Id&quot;,&quot;value&quot;:&quot;Root=1-61b613f3-37678b955845097c7d499e07;Parent=033592cd59b3e60b;Sampled=0&quot;}}
</span><span>+ sleep 1
</span><span>DEBUG: (soraproxy/proxy) 2021/12/12 15:23:32 route POST / to Unified Endpoint
</span><span>--- Request dump ---------------------------------
</span><span>POST / HTTP/1.1
</span><span>Host: 100.127.69.42:80
</span><span>
</span><span>{&quot;key1&quot;:10.2,&quot;key2&quot;:0,&quot;key3&quot;:5}
</span><span>--- End of request dump --------------------------
</span><span>DEBUG: (soraproxy/proxy/tunnel) 2021/12/12 15:23:32 peer(cx/Q…7vVA) - Sending handshake initiation
</span><span>DEBUG: (soraproxy/proxy/tunnel) 2021/12/12 15:23:32 peer(cx/Q…7vVA) - Received handshake response
</span><span>--- Response dump --------------------------------
</span><span>HTTP/1.1 201 Created
</span><span>Connection: close
</span><span>Content-Length: 0
</span><span>Date: Sun, 12 Dec 2021 15:23:32 GMT
</span><span>
</span><span>
</span><span>--- End of response dump -------------------------
</span><span>+ true
</span><span>+ echo &#39;[extension.sh] Waiting for event. Get /next event from http://127.0.0.1:9001/2020-01-01/extension/event/next&#39;
</span><span>[extension.sh] Waiting for event. Get /next event from http://127.0.0.1:9001/2020-01-01/extension/event/next
</span><span>+ PID=50
</span><span>+ forward_sigterm_and_wait
</span><span>+ trap _term SIGTERM
</span><span>+ /opt/bin/curl -sS -L -XGET http://127.0.0.1:9001/2020-01-01/extension/event/next --header &#39;Lambda-Extension-Identifier: xxxxxxxx-6dff-4060-83b5-c3fac699488f&#39;
</span><span>+ wait 50
</span><span>END RequestId: xxxxxxxx-68e3-4be4-a682-e362c35837ff
</span><span>REPORT RequestId: xxxxxxxx-68e3-4be4-a682-e362c35837ff	Duration: 1005.43 ms	Billed Duration: 1006 ms	Memory Size: 512 MB	Max Memory Used: 81 MB	Init Duration: 275.38 ms
</span></code></pre>
<h3 id="shi-sitemitaifang-ha">試してみたい方は</h3>
<p>実験的な機能であることから <a href="https://github.com/soracom/soratun/">soracom/soratun</a> にはマージしていません。soratun のメインのターゲットである Raspberry Pi (の 32-bit 版)を gVisor が <a href="https://github.com/google/gvisor/issues/5692#issuecomment-842600032">正式にサポートしていない</a> ことが大きな理由です。とはいえ soratun はオープンソースとして公開しており、要件に応じたカスタマイズの土台として利用できます。今回のようにすべてユーザー空間で実装する方式にはいろいろな可能性がありそうに思いますのでぜひお試しください。</p>
<p>Lambda extension レイヤーの Zip ファイルアーカイブを作る手順は以下のとおりです。<a href="https://github.com/0x6b/soratun/blob/main/docs/CONTRIBUTING.md">soratun/CONTRIBUTING.md</a> の Prerequisites が必要です。</p>
<pre data-lang="bash" style="background-color:#0f1419;color:#bfbab0;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#ffb454;">$</span><span> git clone https://github.com/0x6b/soratun
</span><span style="color:#ffb454;">$</span><span> cd soratun
</span><span style="color:#ffb454;">$</span><span> git switch soraproxy
</span><span style="color:#ffb454;">$</span><span> make lambda-extension
</span><span style="color:#ffb454;">...
</span><span style="color:#ffb454;">Created</span><span> /path/to/aws-lambda-extension/soraproxy.zip
</span></code></pre>
<p>差分全体は <a href="https://github.com/soracom/soratun/compare/main...0x6b:soraproxy?expand=1">GitHub</a> でご覧ください。</p>
<p>ちなみに、最近の gVisor ではコンパイルに失敗してしまうため少し古めのバージョンを使用しています。コミットログから分かるように <code>soraproxy</code> は結構前から試作していたのですが、アドベントカレンダーしめきり前に最新パッケージにしようとして失敗して焦りました。詳細は追いかけられていません。</p>
<h2 id="matome">まとめ</h2>
<p>wireguard-go と gVisor という超巨人の肩を借りつつ AWS Lambda extension として実装することで、Lambda 関数から簡単にソラコムのプラットフォームサービスを利用できるようになりました。</p>
<p>2021 年 12 月現在、SORACOM Arc は 1 アカウントあたりバーチャル SIM1 契約分の基本使用料(月額)、1GB 分のデータ通信が無料で利用できますのでぜひお試しください。</p>

    </div>

    
    

    <div class="post-footer">
        
            
                <div class="post-tags">
                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line></svg>
                    
                        <a href="https://0x6b.github.io/tags/soracom/">#soracom</a>
                    
                        <a href="https://0x6b.github.io/tags/arc/">#arc</a>
                    
                        <a href="https://0x6b.github.io/tags/aws/">#aws</a>
                    
                        <a href="https://0x6b.github.io/tags/lambda/">#lambda</a>
                    
                        <a href="https://0x6b.github.io/tags/extension/">#extension</a>
                    
                        <a href="https://0x6b.github.io/tags/soratun/">#soratun</a>
                    
                </div>
            
            
        

    </div>

    
    
</article>


        </div>
      </main>

      <footer id="footer">
        <p><a href="https://github.com/0x6b">0x6b</a> / Opinion here is mine, not employer's / <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a></p>
      </footer>
    </div>
  </body>
</html>
